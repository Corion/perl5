name: smoke-windows-msvc100-x86

on:
  push:
    branches:
      - '*'
    tags-ignore:
      - '*'
  pull_request:

env:
    PERL_SKIP_TTY_TEST: 1

jobs:
  perl:

    runs-on: windows-latest

    steps:
      - run: git config --global core.autocrlf false
      - uses: actions/checkout@master
        with:
            fetch-depth: 10
      - name: Cache MSVC100 download
        id: setup-msvc100
        uses: actions/cache@v1
        with:
            path: "d:/chocolatey-cache"
            key: vcexpress2010-chocolatey
      - name: Set up MSVC100
        shell: cmd
        run: |
          choco config set cacheLocation %HOME%\chocolatey-cache
          choco install vcexpress2010
      - name: Cache status
        if: steps.setup-msvc100.outputs.cache-hit != 'true'
        run: echo Fresh download
      - name: MSVC100 Help
        shell: cmd
        run: |
            call "C:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\vcvarsall.bat" /help
      - name: Build
        shell: cmd
        run: |
            call "C:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\vcvarsall.bat" x86
            cd win32
            nmake CCTYPE=MSVC100 WIN64=undef
      - name: Run Tests
        shell: cmd
        run: |
            call "C:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\vcvarsall.bat" x86
            cd win32
            nmake CCTYPE=MSVC100 WIN64=undef test
